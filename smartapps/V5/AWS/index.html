<!DOCTYPE html>
<html>

<head>
    <title>EchoSistant Install</title>
    <meta charset="utf-8">
    <script src="//sdk.amazonaws.com/js/aws-sdk-2.82.0.min.js"></script>
    <style>
        body {
            padding: 1em;
            background: #2B3134;
            color: #777;
            text-align: center;
            font-family: "Gill sans", sans-serif;
            width: 80%;
            margin: 0 auto;
        }

        h1 {
            margin: 1em 0;
            border-bottom: 1px dashed;
            padding-bottom: 1em;
            font-weight: lighter;
        }

        #loader {
            position: absolute;
            left: 50%;
            top: 50%;
            z-index: 1;
            width: 150px;
            height: 150px;
            margin: -75px 0 0 -75px;
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .animate-bottom {
            position: relative;
            -webkit-animation-name: animatebottom;
            -webkit-animation-duration: 1s;
            animation-name: animatebottom;
            animation-duration: 1s
        }

        @-webkit-keyframes animatebottom {
            from {
                bottom: -100px;
                opacity: 0
            }
            to {
                bottom: 0;
                opacity: 1
            }
        }

        @keyframes animatebottom {
            from {
                bottom: -100px;
                opacity: 0
            }
            to {
                bottom: 0;
                opacity: 1
            }
        }

        #results {
            display: none;
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>EchoSistant Installing</h1>
    <div id="loader"></div>
    <div id="results" class="animate-bottom"></div>

    <script type="text/javascript">
        function checkStack(stackName) {
            try {
                var params = {
                    StackName: stackName
                }
                cloudformation.waitFor('stackCreateComplete', params, function (err, data) {
                    if (err) {
                        results.innerHTML = 'ERROR: ' + err;
                    } else {
                        return data.Stacks[0].Outputs[0].OutputValue;
                    }
                });
            } catch (ex) {
                results.innerHTML = ex;
            }
        }

        function installStack() {
            results.innerHTML = 'Hold on to your butts! This can take a few mintues... ';
            var params = {
                StackName: ESStackName,
                Capabilities: [
                    'CAPABILITY_NAMED_IAM',
                ],
                DisableRollback: false,
                Parameters: [{
                        ParameterValue: sturl,
                        ParameterKey: "STurl",
                        UsePreviousValue: true
                    },
                    {
                        ParameterValue: sttoken,
                        ParameterKey: "STtoken",
                        UsePreviousValue: true
                    }
                ],
                TemplateBody: "{'AWSTemplateFormatVersion':'2010-09-09','Parameters':{'STurl':{'Default':'','Type':'String'},'FunctionName':{'Default':'EchoSistantV5','Type':'String','Description':'EchoSistantV5'},'STtoken':{'Default':'','Type':'String'}},'Outputs':{'FunctionARN':{'Value':{'Fn::GetAtt':['EchoSistantV5','Arn']}}},'Resources':{'EchoSistantV5Permissions':{'Type':'AWS::Lambda::Permission','Properties':{'Principal':'alexa-appkit.amazon.com','FunctionName':{'Ref':'EchoSistantV5'},'Action':'lambda:InvokeFunction'}},'EchoSistantV5Role':{'Type':'AWS::IAM::Role','Properties':{'AssumeRolePolicyDocument':{'Version':'2012-10-17','Statement':[{'Principal':{'Service':['lambda.amazonaws.com']},'Action':['sts:AssumeRole'],'Effect':'Allow'}]},'Path':'/','Policies':[{'PolicyName':'EchoSistantV5Policy','PolicyDocument':{'Version':'2012-10-17','Statement':[{'Action':['logs:*','dynamodb:*','cloudformation:*','couldwatch:*','lambda:*'],'Sid':'AllowLogging','Effect':'Allow','Resource':['*']}]}}]}},'EchoSistantV5':{'Type':'AWS::Lambda::Function','Properties':{'FunctionName':{'Ref':'FunctionName'},'Role':{'Fn::GetAtt':['EchoSistantV5Role','Arn']},'Code':{'ZipFile':'exports.handler = (event, context, callback) => { callback(null, true);};'},'Handler':'index.handler','Environment':{'Variables':{'STurl':{'Ref':'STurl'},'STtoken':{'Ref':'STtoken'}}},'Runtime':'nodejs6.10','Description':'EchoSistantV5 Lambda','Timeout':'10'}}}}",
                TimeoutInMinutes: 15
            };
            cloudformation.createStack(params, function (err, data) {
                if (err) {
                    results.innerHTML = 'ERROR: ' + err;
                } else {
                    functionARN = updateLambda(checkStack(data.ResponseMetadata.StackId));
                }
            });
        }

        function checkLambda(functionName) {
            var params = {
                FunctionName: functionName
            };
            lambda.getFunction(params, function (err, data) {
                if (err) {
                    results.innerHTML = 'ERROR: ' + err;
                } else {
                    //data.Configuration.LastModified
                    return data.Configuration.FunctionArn;
                }
            });
        }

        function updateLambda() {
            try {
                fetch(codeURL)
                    .then(function (res) {
                        res.blob().then(function (blob) {
                            var reader = new FileReader();
                            reader.addEventListener("loadend",
                                function () {
                                    var zipFileBlob = reader.result;
                                    var params = {
                                        FunctionName: functionARN,
                                        ZipFile: zipFileBlob
                                    };
                                    lambda.updateFunctionCode(
                                        params,
                                        function (err,
                                            data) {
                                            if (err) {
                                                results.innerHTML =
                                                    'ERROR: ' +
                                                    err;
                                            } else {
                                                return data.FunctionArn;
                                            }
                                        });
                                });
                            reader.readAsArrayBuffer(blob);
                        });
                    });
            } catch (e) {
                results.innerHTML = e;
            }
        }
    </script>
