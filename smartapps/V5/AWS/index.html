<!DOCTYPE html>
<html>

<head>
    <title>EchoSistant Install</title>
    <meta charset="utf-8">
    <script src="//sdk.amazonaws.com/js/aws-sdk-2.82.0.min.js"></script>
    <style>
        body {
            padding: 1em;
            background: #2B3134;
            color: #777;
            text-align: center;
            font-family: "Gill sans", sans-serif;
            width: 80%;
            margin: 0 auto;
        }

        h1 {
            margin: 1em 0;
            border-bottom: 1px dashed;
            padding-bottom: 1em;
            font-weight: lighter;
        }

        #loader {
            height: 100px;
            width: 20%;
            text-align: center;
            padding: 1em;
            margin: 0 auto 1em;
            display: inline-block;
            vertical-align: top;
        }

        svg path,
        svg rect {
            fill: rgb(0%, 51.3%, 100%);
        }

        .animate-bottom {
            position: relative;
            -webkit-animation-name: animatebottom;
            -webkit-animation-duration: 1s;
            animation-name: animatebottom;
            animation-duration: 1s
        }

        @-webkit-keyframes animatebottom {
            from {
                bottom: -100px;
                opacity: 0
            }
            to {
                bottom: 0;
                opacity: 1
            }
        }

        @keyframes animatebottom {
            from {
                bottom: -100px;
                opacity: 0
            }
            to {
                bottom: 0;
                opacity: 1
            }
        }

        #results {
            display: none;
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>EchoSistant Installing</h1>
    <svg id="loader" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="200px"
        height="200px" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50;" xml:space="preserve">
        <path fill="#000" d="M43.935,25.145c0-10.318-8.364-18.683-18.683-18.683c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615c8.072,0,14.615,6.543,14.615,14.615H43.935z">
            <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"
            />
        </path>
    </svg>
    <div id="results" class="animate-bottom"></div>

    <script type="text/javascript">
        var results = document.getElementById('results');
        var loader = document.getElementById('loader');

        function checkStack(stackName) {
            var output = 'ERROR:';
            try {
                var params = {
                    StackName: stackName
                }
                cloudformation.waitFor('stackCreateComplete', params, function (err, data) {
                    if (err) {
                        output = 'ERROR: ' + err;
                    } else {
                        output = data.Stacks[0].Outputs[0].OutputValue;
                    }
                });
            } catch (ex) {
                output = 'ERROR: ' + ex;
            }
            return output;
        }

        function installStack(stackName) {
            var output = 'ERROR:';
            try {
                var params = {
                    StackName: stackName,
                    Capabilities: [
                        'CAPABILITY_NAMED_IAM',
                    ],
                    DisableRollback: false,
                    Parameters: [{
                            ParameterValue: sturl,
                            ParameterKey: "STurl",
                            UsePreviousValue: true
                        },
                        {
                            ParameterValue: sttoken,
                            ParameterKey: "STtoken",
                            UsePreviousValue: true
                        }
                    ],
                    TemplateBody: "{'AWSTemplateFormatVersion':'2010-09-09','Parameters':{'STurl':{'Default':'','Type':'String'},'FunctionName':{'Default':'EchoSistantV5','Type':'String','Description':'EchoSistantV5'},'STtoken':{'Default':'','Type':'String'}},'Outputs':{'FunctionARN':{'Value':{'Fn::GetAtt':['EchoSistantV5','Arn']}}},'Resources':{'EchoSistantV5Permissions':{'Type':'AWS::Lambda::Permission','Properties':{'Principal':'alexa-appkit.amazon.com','FunctionName':{'Ref':'EchoSistantV5'},'Action':'lambda:InvokeFunction'}},'EchoSistantV5Role':{'Type':'AWS::IAM::Role','Properties':{'AssumeRolePolicyDocument':{'Version':'2012-10-17','Statement':[{'Principal':{'Service':['lambda.amazonaws.com']},'Action':['sts:AssumeRole'],'Effect':'Allow'}]},'Path':'/','Policies':[{'PolicyName':'EchoSistantV5Policy','PolicyDocument':{'Version':'2012-10-17','Statement':[{'Action':['logs:*','dynamodb:*','cloudformation:*','couldwatch:*','lambda:*'],'Sid':'AllowLogging','Effect':'Allow','Resource':['*']}]}}]}},'EchoSistantV5':{'Type':'AWS::Lambda::Function','Properties':{'FunctionName':{'Ref':'FunctionName'},'Role':{'Fn::GetAtt':['EchoSistantV5Role','Arn']},'Code':{'ZipFile':'exports.handler = (event, context, callback) => { callback(null, true);};'},'Handler':'index.handler','Environment':{'Variables':{'STurl':{'Ref':'STurl'},'STtoken':{'Ref':'STtoken'}}},'Runtime':'nodejs6.10','Description':'EchoSistantV5 Lambda','Timeout':'10'}}}}",
                    TimeoutInMinutes: 15
                };
                cloudformation.createStack(params, function (err, data) {
                    if (err) {
                        output = 'ERROR: ' + err;
                    } else {
                        output = updateLambda(checkStack(data.ResponseMetadata.StackId));
                    }
                });
            } catch (ex) {
                output = 'ERROR: ' + ex;
            }
            return output
        }

        function checkLambda(functionName) {
            var output = 'ERROR:';
            try {
                var params = {
                    FunctionName: functionName
                };
                lambda.getFunction(params, function (err, data) {
                    if (err) {
                        output = 'ERROR: ' + err;
                    } else {
                        //data.Configuration.LastModified
                        output = data.Configuration.FunctionArn;
                    }
                });
            } catch (ex) {
                output = 'ERROR: ' + ex;
            }
            return output;
        }

        function updateLambda(functionName) {
            var output;
            try {
                fetch(codeURL)
                    .then(function (res) {
                        res.blob().then(function (blob) {
                            var reader = new FileReader();
                            reader.addEventListener("loadend",
                                function () {
                                    var zipFileBlob = reader.result;
                                    var params = {
                                        FunctionName: functionName,
                                        ZipFile: zipFileBlob
                                    };
                                    lambda.updateFunctionCode(params, function (err, data) {
                                        if (err) {
                                            output = 'ERROR: ' + err;
                                        } else {
                                            output = data.FunctionArn;
                                        }
                                    });
                                });
                            reader.readAsArrayBuffer(blob);
                        });
                    });
            } catch (ex) {
                output = 'ERROR: ' + ex;
            }
            return output;
        }
    </script>
